# tldraw 迁移计划

## 概述

本文档记录了将AI Canvas Tool项目从Fabric.js迁移到tldraw的过程。tldraw是一个功能强大的开源绘图库，提供了更好的用户体验和更丰富的功能。

## 迁移原因

1. **功能丰富性**：tldraw提供了更多内置的绘图工具和功能
2. **用户体验**：tldraw具有更现代和直观的用户界面
3. **社区支持**：tldraw有活跃的社区和持续的开发支持
4. **性能优化**：tldraw在性能方面进行了大量优化
5. **扩展性**：tldraw提供了更好的扩展机制

## 迁移步骤

### 1. 环境准备

- 安装tldraw依赖包
- 配置CSS样式文件
- 确保React环境兼容

### 2. 组件替换

#### 已完成的组件替换：
- 创建了[TldrawCanvas.jsx](file:///d%3A/AI/canvas2.0/src/components/TldrawCanvas.jsx)组件，替换了原有的[FabricCanvasFixed.jsx](file:///d%3A/AI/canvas2.0/src/components/FabricCanvasFixed.jsx)
- 保留了现有的图层面板、属性面板、AI面板等UI组件
- 集成了tldraw的核心功能

#### 需要进一步优化的组件：
- 图层管理集成
- 对象添加和修改事件处理
- 工具映射和状态同步

### 3. 功能映射

| Fabric.js功能 | tldraw对应功能 | 状态 |
|---------------|----------------|------|
| 画布绘制 | Tldraw组件 | ✅ 已实现 |
| 图层管理 | useEnhancedLayers hook | ✅ 已集成 |
| 工具切换 | 工具映射机制 | ⏳ 部分实现 |
| 对象操作 | 形状监听机制 | ⏳ 部分实现 |
| 历史记录 | useLayerHistory hook | ✅ 已集成 |

### 4. 数据结构适配

#### 图层数据结构
- 保持现有的图层数据结构不变
- 通过适配器将tldraw的形状数据映射到图层对象

#### 对象数据结构
- 将tldraw的形状数据转换为项目所需的对象格式
- 保持与现有系统的兼容性

### 5. 事件处理

#### 对象添加事件
- 监听tldraw的形状创建事件
- 将新创建的形状转换为项目对象格式
- 添加到当前图层中

#### 对象修改事件
- 监听tldraw的形状修改事件
- 更新对应的图层对象数据
- 触发历史记录保存

#### 工具切换事件
- 将项目工具映射到tldraw工具
- 处理工具状态同步

### 6. 样式和主题

#### CSS集成
- 导入tldraw的默认CSS样式
- 保持与项目现有样式的兼容性

#### 主题定制
- 根据项目需求定制tldraw主题
- 确保UI风格一致性

## 技术实现细节

### 1. 组件架构

```
TldrawCanvas.jsx (主组件)
├── Tldraw (tldraw核心组件)
├── TldrawCustomTools (自定义工具组件)
├── Toolbar (工具栏)
├── EnhancedLayerPanel (增强图层面板)
├── PropertyPanel (属性面板)
├── AIPanel (AI面板)
└── 其他辅助组件
```

### 2. 自定义工具组件

[TldrawCustomTools](file:///d%3A/AI/canvas2.0/src/components/TldrawCanvas.jsx#L17-L48)组件负责：
- 工具映射和切换
- 事件监听和处理
- 与tldraw编辑器的交互

### 3. 数据流

```
用户操作 → tldraw工具 → 形状变化 → 事件监听 → 数据转换 → 图层更新 → 历史记录
```

## 待办事项

### 高优先级
- [ ] 完善工具映射机制
- [ ] 实现完整的对象添加和修改事件处理
- [ ] 优化图层与tldraw形状的同步机制
- [ ] 处理撤销/重做功能与tldraw的集成

### 中优先级
- [ ] 定制tldraw主题以匹配项目UI风格
- [ ] 实现蒙版功能与tldraw的集成
- [ ] 优化性能，特别是大量对象时的表现

### 低优先级
- [ ] 添加更多tldraw的高级功能
- [ ] 实现自定义形状和工具
- [ ] 优化移动端体验

## 风险评估

### 技术风险
1. **数据兼容性**：tldraw的形状数据格式可能与现有系统不完全兼容
   - 缓解措施：实现数据转换适配器

2. **性能问题**：tldraw在大量对象时可能存在性能问题
   - 缓解措施：优化数据结构和渲染机制

3. **功能缺失**：某些Fabric.js特有的功能可能在tldraw中不存在
   - 缓解措施：寻找替代方案或自定义实现

### 迁移风险
1. **用户适应性**：用户需要适应新的界面和交互方式
   - 缓解措施：提供过渡期和用户培训

2. **兼容性问题**：现有项目文件可能无法直接在tldraw中打开
   - 缓解措施：实现文件格式转换工具

## 测试计划

### 功能测试
- 验证所有绘图工具的正常工作
- 测试图层管理功能
- 验证AI集成功能
- 测试历史记录和撤销/重做功能

### 性能测试
- 测试大量对象时的渲染性能
- 验证响应速度和内存使用情况
- 测试不同设备上的表现

### 兼容性测试
- 验证在不同浏览器中的兼容性
- 测试在不同屏幕尺寸下的显示效果
- 验证与现有系统的集成兼容性

## 时间计划

| 阶段 | 任务 | 预计时间 |
|------|------|----------|
| 第1周 | 环境搭建和基础集成 | 2天 |
| 第2周 | 功能映射和事件处理 | 3天 |
| 第3周 | UI优化和主题定制 | 2天 |
| 第4周 | 测试和问题修复 | 3天 |
| 第5周 | 文档编写和用户培训 | 2天 |

## 总结

通过迁移到tldraw，我们能够为用户提供更强大和直观的绘图体验。虽然迁移过程需要一定的工作量，但从长远来看，这将为项目带来更多的功能和更好的用户体验。我们将按照计划逐步完成迁移工作，并确保在迁移过程中不影响现有功能的正常使用。